---
üîç Analyze Conventional Commits:
  stage: prepare
  image: $IMAGE_PYTHON
  variables:
    CONVENTIONAL_COMMITS_REGEXP: ^(build|chore|ci|docs|feat|fix|perf|refactor|style|test|revert|merge|release|hotfix|fixup|squash|wip|BREAKING CHANGE)(\([a-zA-Z0-9_-]+\))?!?:\s.+$
    DOCS_MD_FILE_PATH: ci_jobs/analyze_conventional_commits/README.md
  before_script:
    - !reference [.helper_header_cli.sh]
    - !reference [.helper_gitlab-ci.sh]
  script:
    - |
      echo ""
      h1 "üîç Analyze Conventional Commits"
      IS_ERR="false"

      if [[ $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH ]]; then
        exit 0
      fi

      git fetch origin $CI_DEFAULT_BRANCH  2> /dev/null
      COMMITS=$(git --no-pager log origin/$CI_DEFAULT_BRANCH..HEAD --pretty=format:"%s")

      if [[ $COMMITS == "" ]]; then
        exit 0
      fi

      h2 "üìÉ Wyniki Analizy"
      while IFS= read -r msg; do
        echo "$msg" | grep -Eq "^(Merge|Revert|Initial\scommit)" && continue
        if ! echo "$msg" | grep -Eq "$CONVENTIONAL_COMMITS_REGEXP"; then
          echo "‚ùå Niezgodno≈õƒá z Conventional Commits: \"$msg\""
          IS_ERR="true"
        else
          echo "‚úîÔ∏è Zgodno≈õƒá z Conventional Commits: \"$msg\""
        fi

      done <<< "$COMMITS"

      if [[ $IS_ERR == "true" ]]; then
          exit 1
      fi
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success
