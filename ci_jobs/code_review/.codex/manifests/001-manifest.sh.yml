---
.001-manifest.sh:
  - |
    mkdir -p .codex/manifests
    cat > .codex/manifests/001-manifest.md <<'EOF'
    ==================================================
    TRYB ANALIZY: DIFF + KONTEKST GAŁĘZI ŹRÓDŁOWEJ
    ==================================================

    Założenie:
    - Pipeline CI udostępnia CAŁY kod źródłowy gałęzi źródłowej (source branch),
    - codex-cli ma dostęp:
      - do diffu MR,
      - do pełnego drzewa plików na gałęzi źródłowej,
      - opcjonalnie do gałęzi docelowej (target branch) lub jej snapshotu.

    Zmiana podejścia:
    - PODSTAWĄ review jest nadal DIFF MR,
    - ALE model MA PRAWO:
      - otwierać dowolne pliki z gałęzi źródłowej,
      - porównywać je z odpowiednikami z gałęzi docelowej (jeśli dostępne),
      - sprawdzać spójność zmian w szerszym kontekście.

    Celem jest:
    - wyłapanie braków typu:
      - zmiana interfejsu publicznego bez aktualizacji call-site’ów w innych plikach,
      - dodanie nowej funkcjonalności bez odpowiednich testów / konfiguracji,
      - niekompletne zmiany (np. nowy enum value bez obsługi w innych miejscach).
      - nie kompletnej dokumenacji

    ==================================================
    ZAKRES OCENY – ROZSZERZONY
    ==================================================

    Oceniasz:

    1. DIFF MR (jak wcześniej):
      - zmienione linie kodu,
      - nowe pliki,
      - usunięte pliki.

    2. KONTEKST GAŁĘZI ŹRÓDŁOWEJ:
      - pliki powiązane z modyfikowanym kodem:
        - pliki z tym samym pakietem / modułem,
        - pliki z tym samym bounded context / warstwą,
        - testy powiązane z danym komponentem,
      - użycia zmienionych funkcji / typów / interfejsów w innych plikach:
        - jeśli w MR zmienia się sygnatura funkcji/metody,
          sprawdzasz, czy wszystkie call-site’y w gałęzi źródłowej są spójne,
        - jeśli dodany jest nowy typ/enum value,
          sprawdzasz, czy jest obsłużony w miejscach typu `switch`/`if`.

    3. Spójność konfiguracji:
      - jeżeli MR wprowadza nowe feature flags / zmienne środowiskowe / wpisy w configach:
        - sprawdzasz, czy ich użycie w kodzie jest spójne z definicjami,
        - czy nie ma „martwych” wpisów konfiguracyjnych.
        - czy nie ma credentials (np. haseł, tokenów, danych wrażliwych)

    4. Testy w skali gałęzi:
      - jeżeli MR dodaje/zmienia istotną logikę:
        - sprawdzasz, czy w gałęzi źródłowej istnieją testy dla tego modułu,
        - jeżeli nie – zaznaczasz to jako problem (MAJOR/MINOR zależnie od wagi),
      - możesz wskazać, które pliki testowe powinny zostać rozbudowane
        (np. `internal/core/service_test.go`).

    ==================================================
    OGRANICZENIA I PRIORYTETY (GAŁĄŹ ŹRÓDŁOWA)
    ==================================================

    1. Priorytet nadal ma DIFF:
      - komentarze muszą BYĆ POWIĄZANE z bieżącym MR,
      - szersza analiza gałęzi źródłowej służy wyłącznie:
        - wykryciu braków i niespójności,
        - lepszej ocenie wpływu zmian.

    2. Zakres analizy całej gałęzi:
      - nie wykonujesz pełnego, liniowego „code review całego repozytorium”,
      - patrzysz selektywnie:
        - w modułach/plikach, które są logicznie związane ze zmianami,
        - w miejscach, gdzie zmiana wymaga konsekwencji w innych plikach.

    3. Komentarze:
      - nadal raportujesz uwagi w kontekście konkretnego MR,
      - jeżeli problem jest w pliku, który nie występuje w diffie,
        ale JEST konsekwencją zmian z MR:
        - wyraźnie to oznaczasz, np.:

    ==================================================
    LOKALIZACJA DOKUMENTÓW I PROMPTÓW CODEX
    ==================================================

    1. Wszystkie dokumenty sterujące pracą codex-cli:
      - manifesty,
      - tryby pracy,
      - profile roli,
      - zasady Code Review,
      - wyjątki i rozszerzenia,

      MUSZĄ znajdować się w katalogu:

      .codex/

    2. W szczególności:
      - .codex/prompts/        → aktywne prompty i tryby pracy,
      - .codex/manifests/     → manifesty główne i ich wersje,
      - .codex/profiles/      → profile ról (np. reviewer, architekt, devops),
      - .codex/docs/          → dokumentacja operacyjna dla codex-cli (jeśli potrzebna).

    3. Katalog `.codex/` jest:
      - JEDYNYM źródłem prawdy dla zachowania codex-cli,
      - ładowany automatycznie przy starcie joba w GitLab CI,
      - traktowany jako rozszerzenie konfiguracji projektu.

    4. Bezwzględny zakaz:
      - ignorowania zawartości katalogu `.codex/`,
      - nadpisywania reguł z `.codex/` regułami lokalnymi w kodzie,
      - ręcznej ingerencji w zachowanie codex-cli poza plikami w `.codex/`.

    5. Jeśli istnieje sprzeczność:
      główny manifest → .codex/prompts → pojedynczy tryb (np. code-review)

      kolejność ta jest WIĄŻĄCA i nie podlega interpretacji.

    6. Każda zmiana w `.codex/`:
      - MUSI być wersjonowana w repozytorium,
      - obowiązuje od następnej iteracji pipeline,
      - podlega Code Review tak samo jak kod produkcyjny.
    EOF
