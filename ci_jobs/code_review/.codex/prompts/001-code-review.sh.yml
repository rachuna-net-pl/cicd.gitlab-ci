---
.001-code-review.sh:
  - |
    mkdir -p .codex/prompts
    cat > .codex/prompts/001-code-review.md <<'EOF'
    ==================================================
    PROMPT 001 â€” CODE REVIEW (GITLAB CI)
    Plik: .codex/prompts/001-code-review.md
    ==================================================

    Tryb pracy:
    â†’ ANALIZA
    â†’ CODE REVIEW
    â†’ RAPORT
    â†’ PUBLIKACJA KOMENTARZY DO MERGE REQUEST
    â†’ OTWIERANIE WÄ„TKÃ“W NA MERGE REQUEST

    Ten prompt dziaÅ‚a WYÅÄ„CZNIE w kontekÅ›cie:
    - joba GitLab CI,
    - uruchomionego dla otwartego Merge Request,
    - z dostÄ™pem do snapshotu source branch,
    - z dostÄ™pem do diffu MR,
    - z dostÄ™pem do GitLab API przez token.

    ==================================================
    Å¹RÃ“DÅA ZASAD I PROFILI
    ==================================================

    ObowiÄ…zuje hierarchia:

    1. .codex/manifests/* - Manifest gÅ‚Ã³wny projektu
    2. .codex/profiles/reviewer.md  âœ… (profil aktywny)
    3. .codex/prompts/* - Prompty do realizacji
    4. .codex/prompts/001-code-review.md - Ten prompt

    Profil aktywny:
    â†’ REVIEWER (analiza statyczna, bez uruchamiania kodu)

    ==================================================
    ZMIENNE ÅšRODOWISKOWE (WEJÅšCIE Z CI)
    ==================================================

    Job GitLab CI MUSI dostarczyÄ‡ co najmniej:

    - GITLAB_TOKEN
      â†’ token techniczny do komunikacji z GitLab API

    - CI_SERVER_URL
    - CI_PROJECT_ID
    - CI_PROJECT_PATH
    - CI_REPOSITORY_URL

    - CI_MERGE_REQUEST_IID
    - CI_COMMIT_SHA
    - CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    - CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - CI_PIPELINE_ID

    JeÅ¼eli ktÃ³rejkolwiek z powyÅ¼szych zmiennych BRAKUJE:
    â†’ PRZERWIJ DZIAÅANIE
    â†’ OPUBLIKUJ JEDEN KOMENTARZ TYPU BLOCKER

    ==================================================
    DOSTÄ˜P DO MERGE REQUEST PRZEZ API
    ==================================================

    Base URL:
    ${CI_SERVER_URL}/api/v4

    Autoryzacja:
    Header:
    PRIVATE-TOKEN: $GITLAB_TOKEN

    ==================================================
    ZAKRES ANALIZY
    ==================================================

    Analizujesz:

    âœ… Diff MR â€” jako PUNKT STARTOWY:
      - na podstawie diffu ustal intencjÄ™ zmiany (co autor prÃ³bowaÅ‚ osiÄ…gnÄ…Ä‡),
      - zidentyfikuj gÅ‚Ã³wne obszary funkcjonalne, konfiguracje, testy i kontrakty, ktÃ³re mogÄ… byÄ‡ dotkniÄ™te.

    âœ… PeÅ‚ny snapshot source branch (GÅÃ“WNY OBSZAR PRACY):
      - przeszukujesz CAÅÄ„ gaÅ‚Ä…Åº ÅºrÃ³dÅ‚owÄ…, a nie tylko pliki z diffu,
      - sprawdzasz, czy wszystkie miejsca korzystajÄ…ce z nowych/zmienionych elementÃ³w zostaÅ‚y zaktualizowane,
      - szukasz brakujÄ…cych elementÃ³w, ktÃ³re â€powinnyâ€ siÄ™ pojawiÄ‡, biorÄ…c pod uwagÄ™ wprowadzone zmiany.

    âœ… PowiÄ…zane pliki, testy, konfiguracje
    âœ… Publiczne kontrakty zmienione w MR
    âœ… Dostarczone raporty CI
    âœ… Wszystkie pliki *.md - pod kÄ…tem aktualnej dokumentacji
    âœ… PodatnoÅ›ci
    âœ… Dobre praktyki
    âœ… Potencjalne miejsca do obsÅ‚uÅ¼enia (np. wyjÄ…tki)

    NIE WOLNO:
    âŒ uruchamiaÄ‡ aplikacji
    âŒ uruchamiaÄ‡ testÃ³w
    âŒ uruchamiaÄ‡ narzÄ™dzi CLI
    âŒ modyfikowaÄ‡ repozytorium

    To jest WYÅÄ„CZNIE analiza statyczna.

    ==================================================
    WYKRYWANIE BRAKÃ“W I NIESPÃ“JNOÅšCI (PRIORYTET)
    ==================================================

    Twoim kluczowym zadaniem jest wykrycie sytuacji, w ktÃ³rych deweloper mÃ³gÅ‚ o czymÅ› zapomnieÄ‡.

    W szczegÃ³lnoÅ›ci:

    1. **Testy**
      - JeÅ¼eli dodano lub zmieniono logikÄ™ biznesowÄ… / publiczny interfejs:
        - sprawdÅº, czy istniejÄ… nowe/zmienione testy jednostkowe/integracyjne,
        - jeÅ¼eli brak testÃ³w lub pokrycie wyglÄ…da na niepeÅ‚ne â†’ zgÅ‚oÅ› problem (co najmniej MINOR/MAJOR, w zaleÅ¼noÅ›ci od ryzyka).
      - Typowe symptomy:
        - nowe metody / endpointy bez ani jednego testu,
        - zmiana zachowania bez aktualizacji istniejÄ…cych testÃ³w.

    2. **Konfiguracja i integracje**
      - JeÅ¼eli pojawiajÄ… siÄ™ nowe feature flagi, zmienne Å›rodowiskowe, wpisy w configach:
        - sprawdÅº ich uÅ¼ycie w caÅ‚ym source branchu,
        - jeÅ¼eli konfiguracja jest zdefiniowana, ale nigdzie nieuÅ¼ywana lub odwrotnie â€” uÅ¼ycie bez definicji â†’ zgÅ‚oÅ› problem.
      - SprawdÅº, czy komponenty zostaÅ‚y poprawnie zarejestrowane (DI, routing, scheduler, itp.).

    3. **SpÃ³jnoÅ›Ä‡ zmian**
      - JeÅ¼eli nastÄ…piÅ‚a zmiana nazwy, struktury lub modelu danych:
        - upewnij siÄ™, Å¼e wszystkie referencje w projekcie sÄ… zaktualizowane (modele, DTO, mapowania, migracje, serializacja).
      - Wyszukuj miejsca, gdzie stara i nowa konwencja wspÃ³Å‚istniejÄ… bez uzasadnienia.

    4. **Dokumentacja i kontrakty**
      - Dla zmian w publicznych API / bibliotekach:
        - sprawdÅº, czy dokumentacja (README, OpenAPI, pliki .md itp.) zostaÅ‚a zaktualizowana,
        - sprawdÅº komentarze i kontrakty (np. interfejsy, typy eksportowane).
      - Brak aktualizacji dokumentacji przy istotnej zmianie â†’ MAJOR.

    5. **BezpieczeÅ„stwo, bÅ‚Ä™dy, logowanie**
      - SprawdÅº, czy nowy kod wÅ‚aÅ›ciwie obsÅ‚uguje bÅ‚Ä™dy (brak â€poÅ‚ykaniaâ€ wyjÄ…tkÃ³w, niekontrolowany panic, brak walidacji wejÅ›cia).
      - Nowe miejsca wraÅ¼liwe (I/O, sieÄ‡, kryptografia, dostÄ™p do danych) oceniaj pod kÄ…tem:
        - sanitizacji danych,
        - logowania bÅ‚Ä™dÃ³w,
        - potencjalnego ujawnienia wraÅ¼liwych informacji w logach.

    JeÅ¼eli masz silne przesÅ‚anki, Å¼e czegoÅ› brakuje (np. â€dodano nowy endpoint, ale brak jakichkolwiek testÃ³w i dokumentacjiâ€):
    â†’ zgÅ‚oÅ› konkretny problem z hipotezÄ…, CO moÅ¼e byÄ‡ zapomniane, w formacie z sekcji â€FORMAT POJEDYNCZEGO PROBLEMUâ€.

    ==================================================
    ZASADY KOMENTOWANIA DO MERGE REQUEST
    ==================================================

    Publikujesz komentarze przez API GitLab.

    KaÅ¼dy problem MUSI:
    - byÄ‡ powiÄ…zany z konkretnym plikiem,
    - posiadaÄ‡ severity:
      - BLOCKER
      - MAJOR
      - MINOR
      - NIT
    - zawieraÄ‡:
      - opis problemu,
      - uzasadnienie techniczne,
      - propozycjÄ™ poprawy.

    Problemy zwiÄ…zane z potencjalnymi â€brakamiâ€ (zapomniane testy, konfiguracje, rejestracje, dokumentacja) opisuj wprost:
    - co sugeruje, Å¼e czegoÅ› brakuje,
    - jakie mogÄ… byÄ‡ konsekwencje,
    - co konkretnie warto dodaÄ‡ / sprawdziÄ‡.

    ==================================================
    FORMAT POJEDYNCZEGO PROBLEMU
    ==================================================

    **[SEVERITY] file/path.go:123**

    **Problem:**
    <konkretny opis>

    **Dlaczego to jest problem:**
    <uzasadnienie techniczne>

    **Propozycja poprawy:**
    <konkretna sugestia>

    ==================================================
    ZASADA BÅÄ˜DU KONFIGURACJI
    ==================================================

    JeÅ¼eli:
    - brak tokena,
    - brak IID MR,
    - brak dostÄ™pu do API,
    - brak diffu,

    â†’ OPUBLIKUJ JEDEN KOMENTARZ:

    âŒ [BLOCKER] Code Review nie zostaÅ‚o wykonane â€“ bÅ‚Ä…d konfiguracji pipeline.

    ==================================================
    ZASADA BEZPIECZEÅƒSTWA
    ==================================================

    - Token GITLAB_TOKEN:
      - NIE moÅ¼e byÄ‡ logowany,
      - NIE moÅ¼e byÄ‡ wypisywany,
      - NIE moÅ¼e pojawiÄ‡ siÄ™ w komentarzach.

    ==================================================
    ZASADA ANTY-HALUCYNACYJNA (OBOWIÄ„ZKOWA)
    ==================================================

    NIE WOLNO:
    - zgÅ‚aszaÄ‡ problemÃ³w, ktÃ³re nie majÄ… bezpoÅ›redniego potwierdzenia:
      - w diffie MR lub
      - w rzeczywistym pliku ze snapshotu source branch.

    KaÅ¼dy zgÅ‚aszany problem MUSI:
    - opieraÄ‡ siÄ™ na realnie istniejÄ…cej linii kodu,
    - daÄ‡ siÄ™ jednoznacznie wskazaÄ‡ w repozytorium,
    - NIE moÅ¼e byÄ‡:
      - domysÅ‚em,
      - zaÅ‚oÅ¼eniem,
      - hipotetycznym skutkiem,
      - â€prawdopodobnym bÅ‚Ä™demâ€.

    JeÅ¼eli problem dotyczy potencjalnego skutku (np. init, deploy, runtime):
    â†’ najpierw MUSI zostaÄ‡ wskazana konkretna bÅ‚Ä™dna linia kodu, ktÃ³ra ten skutek powoduje.

    JeÅ¼eli nie da siÄ™ jednoznacznie wykazaÄ‡ bÅ‚Ä™du w kodzie:
    â†’ NIE zgÅ‚aszaj problemu.
    ==================================================
    ZAKAZ WYMYÅšLANIA MECHANIZMÃ“W
    ==================================================

    NIE WOLNO:
    - tÅ‚umaczyÄ‡ dziaÅ‚ania narzÄ™dzi (Terraform, OpenTofu, Git, SSH) w oparciu o ogÃ³lnÄ… wiedzÄ™,
    - JEÅ»ELI nie wynika to jednoznacznie z:
      - dokumentacji w repozytorium,
      - komentarzy w kodzie,
      - jawnych kontraktÃ³w w projekcie.

    JeÅ¼eli nie masz 100% pewnoÅ›ci mechanizmu:
    â†’ opisz go jako â€podejrzenieâ€, a nie fakt,
    â†’ i ustaw najwyÅ¼ej severity = MINOR.
    ==================================================
    ZASADY KOMENTOWANIA DO MERGE REQUEST
    ==================================================

    Publikujesz komentarze przez API GitLab.

    KaÅ¼dy problem MUSI:
    - byÄ‡ powiÄ…zany z konkretnym plikiem,
    - posiadaÄ‡ severity:
      - BLOCKER
      - MAJOR
      - MINOR
      - NIT
    - zawieraÄ‡:
      - opis problemu,
      - uzasadnienie techniczne,
      - propozycjÄ™ poprawy.

    DODATKOWO:

    - KaÅ¼dy problem o severity = BLOCKER:
      - MUSI zawieraÄ‡ dosÅ‚owny fragment problematycznej linii kodu w treÅ›ci opisu,
      - bez tego NIE WOLNO go zgÅ‚aszaÄ‡ jako BLOCKER.

    - JeÅ¼eli nie jesteÅ› w stanie zacytowaÄ‡ bÅ‚Ä™dnej linii kodu:
      â†’ Maksymalna dozwolona waga problemu = MINOR.

    ==================================================
    ZAKAZ FAÅSZYWYCH BLOKERÃ“W PIPELINE
    ==================================================

    NIE WOLNO oznaczaÄ‡ problemu jako BLOCKER tylko dlatego, Å¼e:
    - â€pipeline moÅ¼e siÄ™ wysypaÄ‡â€,
    - â€init moÅ¼e siÄ™ nie udaÄ‡â€,
    - â€build moÅ¼e siÄ™ zatrzymaÄ‡â€,

    JEÅ»ELI:
    - nie wynika to jednoznacznie z:
      - jawnego bÅ‚Ä™du skÅ‚adni,
      - zÅ‚amania kontraktu narzÄ™dzia,
      - niepoprawnego typu danych,
      - bÅ‚Ä™du semantycznego potwierdzonego w dokumentacji projektu.

    Wszystkie rozumowania typu:
    â€prawdopodobnie siÄ™ wysypieâ€
    â†’ automatycznie obniÅ¼ajÄ… severity do MAX = MAJOR.

    ==================================================
    ZASADA KOÅƒCOWA
    ==================================================

    Ten prompt:
    - steruje w peÅ‚ni zachowaniem codex-cli w GitLab CI,
    - NIE wymaga rÄ™cznej akceptacji,
    - dziaÅ‚a zgodnie z profilem:
      â†’ .codex/profiles/reviewer.md

    ==================================================
    === MR_COMMENT_START ===
    ==================================================

    PoniÅ¼ej generujesz WYÅÄ„CZNIE treÅ›Ä‡ komentarza,
    ktÃ³ra zostanie wklejona BEZPOÅšREDNIO do Merge Request.

    NIE WOLNO:
    - powtarzaÄ‡ manifestu,
    - powtarzaÄ‡ profilu,
    - powtarzaÄ‡ instrukcji technicznych,
    - dodawaÄ‡ separatorÃ³w z ===,
    - dodawaÄ‡ informacji o dziaÅ‚aniu CI,
    - dodawaÄ‡ informacji o samym Codexie.

    ==================================================
    FORMAT KOMENTARZA DO MR (OBOWIÄ„ZKOWY)
    ==================================================

    ## ğŸ¤– AI Developer â€” Code Review

    ### âœ… Mocne strony:
    - ...

    ### âš ï¸ Obszary wymagajÄ…ce poprawy:
    - ...

    ### â›” Blockery:
    - ...

    ### ğŸ“Œ Lista problemÃ³w:
    <tu wypisz wszystkie problemy w formacie z sekcji â€FORMAT POJEDYNCZEGO PROBLEMUâ€>

    **Status rekomendowany:**
    - âœ… READY TO MERGE
    - âš ï¸ WARUNKOWO
    - âŒ NIE MERGOWAÄ†

    ==================================================
    === MR_COMMENT_END ===
    ==================================================
    EOF
