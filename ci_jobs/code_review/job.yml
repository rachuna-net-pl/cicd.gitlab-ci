---
include:
  - local: "ci_jobs/code_review/.codex/prompts/001-code-review.sh.yml"

üïµ AI Code Review:
  stage: release
  image: $IMAGE_CODEX
  variables:
    DOCS_MD_FILE_PATH: "ci_jobs/code_review/README.md"
    AI_REVIEWER_USERNAME: tech.mrachuna
    CODEX_MODEL: "gpt-5-codex"
    CODEX_LOG: ".codex/codex-exec.log"
    REVIEW_OUTPUT: ".codex/artifacts/review-output.json"
  before_script:
    - !reference [.helper_header_cli.sh]
    - !reference [.helper_gitlab-ci.sh]
    - |
      echo ""
      h1 "‚öôÔ∏è  Configure Code Reviewer"
      mkdir -p $HOME/.codex .codex/prompts .codex/artifacts
      VAULT_SECRETS=$(curl -sS -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/kv-gitlab/data/pl.rachuna-net/auth/codex")
      echo $VAULT_SECRETS | jq -r '.data.data.AUTH_CONFIG' > $HOME/.codex/auth.json
      export GITLAB_TOKEN=$(echo $VAULT_SECRETS | jq -r '.data.data.GITLAB_TOKEN')
    - !reference [.001-code-review.sh]
  script:
    - |
      echo ""
      MR_JSON=$(curl -sS -H "PRIVATE-TOKEN: $GITLAB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID")
      REVIEWER_LOGINS=$(echo "$MR_JSON" | jq -r '.reviewers[].username')

      if ! echo "$REVIEWER_LOGINS" | grep -Fq -- "$AI_REVIEWER_USERNAME"; then
        echo "‚õî Ten MR nie ma wymaganego reviewera ‚Äì pomijam AI Code Review."
        exit 0
      fi

      if [ -z "$CI_MERGE_REQUEST_IID" ]; then
        echo "‚õî Brak CI_MERGE_REQUEST_IID ‚Äì nie jeste≈õmy w pipeline MR. Ko≈Ñczƒô."
        exit 0
      fi

      h1 "üöÄ Code Review"

      h2 Generuje diff
      git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" 2> /dev/null
      git diff "origin/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}" "origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}" > .codex/artifacts/mr-diff

      if [ ! -s .codex/artifacts/mr-diff ]; then
        echo "Brak zmian w MR"
        exit 0
      fi

      h2 Uruchamiam codex
      {
        cat .codex/prompts/001-code-review.md
        echo
        echo "## MR_DIFF_START"
        cat .codex/artifacts/mr-diff
        echo "## MR_DIFF_END"
      } | codex exec \
          --model "${CODEX_MODEL}" \
          --sandbox danger-full-access \
          --cd "$CI_PROJECT_DIR" \
          - \
          >> "$CODEX_LOG" 2>&1 || EXIT_CODE=$?

      ls -l .codex/artifacts

      if [ ! -f .codex/artifacts/code-review.md ]; then
        echo "Codex nie zwr√≥ci≈Ç ≈ºadnej tre≈õci ‚Äì wstawiam fallback."
        mr_comment "Nie uda≈Ço siƒô uzyskaƒá odpowiedzi od AI Developer. Sprawd≈∫ logi joba."
        cat $CODEX_LOG
        exit 0
      fi

      h2 "Publikujƒô komentarz AI Developer do MR"
      HTTP_CODE=$(curl -sS -o /tmp/ai_note_response.json -w "%{http_code}" \
        -X POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data-urlencode "body=$(cat .codex/artifacts/code-review.md)" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
      )

      echo "HTTP_CODE: ${HTTP_CODE}"

      if [ "$HTTP_CODE" -ge 400 ]; then
        echo "‚ùå B≈ÇƒÖd podczas publikacji komentarza:"
        cat /tmp/ai_note_response.json || true
        exit 1
      else
        echo "‚úÖ Komentarz AI Developer zosta≈Ç dodany do MR"
      fi

      h2 "Przygotowujƒô wƒÖtki (discussions) z discussion.json"
      if [ -f .codex/artifacts/discussion.json ]; then
        jq -c '.[]' .codex/artifacts/discussion.json | while read -r item; do
          body=$(echo "$item" | jq -r '.body')
          position=$(echo "$item" | jq -c '.position // empty')

          if [ -n "$position" ]; then
            payload=$(jq -n --arg body "$body" --argjson position "$position" '{body: $body, position: $position}')
          else
            payload=$(jq -n --arg body "$body" '{body: $body}')
          fi

          HTTP_CODE=$(curl -sS -o /tmp/ai_discussion_response.json -w "%{http_code}" \
            -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "$payload" \
            "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/discussions"
          )

          echo "HTTP_CODE: ${HTTP_CODE}"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "‚ùå B≈ÇƒÖd podczas publikacji wƒÖtku:"
            cat /tmp/ai_discussion_response.json || true
            exit 1
          else
            echo "‚úÖ WƒÖtek zosta≈Ç dodany do MR"
          fi
        done
      else
        echo "Brak .codex/artifacts/discussion.json ‚Äì pomijam tworzenie wƒÖtk√≥w."
      fi
  artifacts:
    when: always
    paths:
      - .codex
    expire_in: "1 day"
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never
