---
variables:
  DOCKER_HOST: tcp://localhost:2375
  BUILDAH_CONFIG_FILE_PATH: config.yml
  STORAGE_DRIVER: vfs
  BUILDAH_FORMAT: docker
  BUILDAH_ISOLATION: chroot
  BUILDAH_STORAGE_ROOT: /tmp/buildah-root
  BUILDAH_STORAGE_RUNROOT: /tmp/buildah-runroot
  BUILDAH_UNSHARE: 0
  DOCKER_TEST_SCRIPT_PATH: "container_test.sh"
  DOCS_MD_FILE_PATH: ci_pipelines/image-builder/README.md

include:
  - local: "ci_pipelines/image-builder/image-builder.sh.yml"

üî¨ Validate files (conftest):
  extends: [".conftest:base"]
  variables:
    PLATFORM_POLICIES_NAMESPACE: image_builder
    PLATFORM_POLICIES_FILES: config.yml
  rules:
    - when: on_success

üöÄ build container image:
  stage: build
  image: $IMAGE_BUILDAH
  needs:
    - job: üïµ YAML lint
      optional: true
    - job: üî¨ Validate files (conftest)
    - job: üïµ Set Version
      artifacts: true
  services:
    - name: $IMAGE_BUILDAH
      alias: buildah-dind
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - FULL_IMAGE_NAME=$CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
  script:
    - !reference [.image-builder.sh]
  after_script:
    - !reference [.helper_readme.sh]
  artifacts:
    paths:
      - container-image.tar
    expire_in: "1 day"
  rules:
    - when: on_success

üåê publish container image:
  stage: publish
  image: $IMAGE_BUILDAH
  needs:
    - job: üöÄ build container image
      artifacts: true
    - job: üïµ Set Version
      artifacts: true
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - FULL_IMAGE_NAME=$CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
  script:
    - |
      buildah pull "docker-archive:container-image.tar"

      IMAGE_ID=$(buildah images -q | head -n1)

      buildah tag "$IMAGE_ID" "$FULL_IMAGE_NAME"
      buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
      buildah push "$FULL_IMAGE_NAME" "docker://$FULL_IMAGE_NAME"
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

üß™ test docker image:
  image: $CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
  stage: "integration-test"
  needs:
    - job: üåê publish container image
      artifacts: true
    - job: üïµ Set Version
      artifacts: true
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  after_script:
    - !reference [.helper_readme.sh]
  script:
    - bash $DOCKER_TEST_SCRIPT_PATH

üî¨ trivy (dast):
  image: $IMAGE_TRIVY
  stage: integration-test
  services:
    - name: $IMAGE_TRIVY
      alias: trivy-dind
  allow_failure: true
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  script:
    - |
      export IMAGE_TO_SCAN="$CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION"

      # 1) Skan + surowy JSON
      trivy image --exit-code 0 --format json -o trivy-report.json "$IMAGE_TO_SCAN"

      # 2) HTML (czytelne do rƒôcznej analizy)
      trivy image --exit-code 0 --format template --template "@/opt/trivy/templates/html.tpl" -o trivy-report.html "$IMAGE_TO_SCAN"

      # 3) SARIF (pod zewn. analizatory / archiwizacjƒô)
      trivy image --exit-code 0 --format sarif -o trivy-report.sarif "$IMAGE_TO_SCAN"

      # 4) SBOM CycloneDX (przydatne do compliance i p√≥≈∫niejszych analiz)
      trivy image --exit-code 0 --format cyclonedx -o trivy-sbom.cdx.json "$IMAGE_TO_SCAN"

      # 5) JUnit (≈ºeby GitLab CE pokaza≈Ç wynik jako "Test Report")
      trivy image --exit-code 0 --severity HIGH,CRITICAL --format template --template "@/opt/trivy/templates/junit.tpl" -o trivy-junit.xml "$IMAGE_TO_SCAN"

      # 6) Gate: fail pipeline je≈õli sƒÖ HIGH/CRITICAL (lub wg Twojej zmiennej)
      trivy image --exit-code 0 --severity HIGH $CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
      trivy image --exit-code 1 --severity CRITICAL $CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION
  after_script:
    - !reference [.helper_readme.sh]
  cache:
    paths:
      - .trivycache/
  artifacts:
    reports:
      junit: trivy-junit.xml
    paths:
      - trivy-report.json
      - trivy-report.html
      - trivy-report.sarif
      - trivy-sbom.cdx.json
      - trivy-junit.xml
