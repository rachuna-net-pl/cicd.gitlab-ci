---
.image-builder.sh:
  - |
    #/bin/bash
    set -euo pipefail
    echo -e "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo -e "â”‚     \033[1;33m IMAGE BUILDER \033[0m                                                                                                                   â”‚"
    echo -e "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    BASE_IMAGE=$(yq -r '.base_image' "$BUILDAH_CONFIG_FILE_PATH")
    FULL_IMAGE_NAME="$CI_REGISTRY_IMAGE:$RELEASE_CANDIDATE_VERSION"

    ### Before script
    echo -e "\033[1;33m===>\033[0m ðŸ”§  Before build scripts"
    before_cmds=$(yq -r '.before_build_commands[]?' "$BUILDAH_CONFIG_FILE_PATH")
    if [[ -n "$before_cmds" ]]; then
    while IFS= read -r cmd; do
        echo "  â†’ $cmd"
        eval "$cmd"
    done <<< "$before_cmds"
    fi

    ### Build the image
    echo -e "\033[1;33m===>\033[0m ðŸ“¦  Base image: $BASE_IMAGE"
    BUILDAH_CMD="buildah --storage-driver vfs --root $BUILDAH_STORAGE_ROOT --runroot $BUILDAH_STORAGE_RUNROOT"
    ctr=$($BUILDAH_CMD from "$BASE_IMAGE")
    mnt=$($BUILDAH_CMD mount "$ctr")

    ### Reading os release
    echo -e "\033[1;33m===>\033[0m ðŸ“„  Reading /etc/os-release"

    OS_RELEASE=$($BUILDAH_CMD run "$ctr" -- cat /etc/os-release)
    ID_LIKE=$(echo "$OS_RELEASE" | grep "^ID_LIKE=" | cut -d= -f2 | tr -d '"')
    ID=$(echo "$OS_RELEASE" | grep "^ID=" | cut -d= -f2 | tr -d '"')
    OS_FAMILY="${ID_LIKE:-$ID}"
    echo "  OS_FAMILY: $OS_FAMILY"

    ### Labels
    echo -e "\033[1;33m===>\033[0m ðŸ·ï¸  Applying labels"
    yq -r '.labels // {} | to_entries[] | "\(.key)=\(.value)"' "$BUILDAH_CONFIG_FILE_PATH" | while IFS='=' read -r key val; do
    echo "  â†’ $key=$val"
    $BUILDAH_CMD config --label "$key=$val" "$ctr"
    done

    ### Install ca-cert
    echo -e "\033[1;33m===>\033[0m ðŸ’¿  Install ca-certificates"
    case "$OS_FAMILY" in
    *debian*|*ubuntu*)
        $BUILDAH_CMD run "$ctr" -- apt-get update
        $BUILDAH_CMD run "$ctr" -- apt-get install -y ca-certificates
        $BUILDAH_CMD run "$ctr" -- apt-get clean
        ;;
    *rhel*|*fedora*|*centos*)
        $BUILDAH_CMD run "$ctr" -- dnf update
        $BUILDAH_CMD run "$ctr" -- dnf update ca-certificates
        $BUILDAH_CMD run "$ctr" -- update-ca-trust enable
        $BUILDAH_CMD run "$ctr" -- update-ca-trust extract
        ;;
    *alpine*)
        $BUILDAH_CMD run "$ctr" -- apk add --no-cache ca-certificates
        $BUILDAH_CMD run "$ctr" -- update-ca-certificates
        ;;
    *)
        echo "âŒ  Unknown system family: $OS_FAMILY" >&2
        exit 1
        ;;
    esac

    ### configure repositories
    echo -e "\033[1;33m===>\033[0m ðŸ“¦  Configure repositories"

    for repo_idx in $(yq -r '.custom_repos | to_entries | .[].key' "$BUILDAH_CONFIG_FILE_PATH"); do
        name=$(yq -r ".custom_repos[$repo_idx].name" "$BUILDAH_CONFIG_FILE_PATH")
        key_url=$(yq -r ".custom_repos[$repo_idx].key_url // \"\"" "$BUILDAH_CONFIG_FILE_PATH")
        key_path=$(yq -r ".custom_repos[$repo_idx].key_path // \"\"" "$BUILDAH_CONFIG_FILE_PATH")
        repo_entry=$(yq -r ".custom_repos[$repo_idx].repo_entry" "$BUILDAH_CONFIG_FILE_PATH")

        TMPDIR=$(mktemp -d)

        echo -e "\n  ðŸ”§  Repo: \033[1m$name\033[0m"
        echo "  ðŸ”—  repo_entry: $repo_entry"
        if [[ -n "$key_url" ]]; then
        echo "  ðŸ”  key_url: $key_url"
        echo "  ðŸ“  key_path: $key_path"
        if curl -fsSL "$key_url" -o "$TMPDIR/key.gpg"; then
            $BUILDAH_CMD copy "$ctr" "$TMPDIR/key.gpg" "$key_path"
        else
            echo -e "\033[1;31m[ERROR]\033[0m  âŒ  Failed to download GPG key from $key_url"
            rm -rf "$TMPDIR"
            exit 1
        fi
        else
        echo "  âš ï¸  No GPG key provided. Skipping key import."
        fi

        echo "$repo_entry" > "$TMPDIR/${name}.list"
        $BUILDAH_CMD copy "$ctr" "$TMPDIR/${name}.list" "/etc/apt/sources.list.d/${name}.list"

        rm -rf "$TMPDIR"
    done

    ### Install packages
    PACKAGES=$(yq -r '.packages // [] | join(" ")' "$BUILDAH_CONFIG_FILE_PATH")
    echo -e "\033[1;33m===>\033[0m ðŸ“¦  Installing packages: $PACKAGES"
    if [[ -n "$PACKAGES" ]]; then
        case "$OS_FAMILY" in
        *debian*|*ubuntu*)
            $BUILDAH_CMD run "$ctr" -- apt-get update
            $BUILDAH_CMD run "$ctr" -- apt-get install -y $PACKAGES
            ;;
        *rhel*|*fedora*|*centos*)
            $BUILDAH_CMD run "$ctr" -- dnf update
            $BUILDAH_CMD run "$ctr" -- dnf install -y $PACKAGES
            ;;
        *alpine*)
            $BUILDAH_CMD run "$ctr" -- apk add --no-cache $PACKAGES
            ;;
        *)
            echo "âŒ  Unknown system family: $OS_FAMILY" >&2
            exit 1
            ;;
        esac
    fi

    ### Copy files
    echo -e "\033[1;33m===>\033[0m ðŸ“¦  Copy files"
    for idx in $(yq -r '.copy | to_entries | .[].key' "$BUILDAH_CONFIG_FILE_PATH"); do
    src=$(yq -r ".copy[$idx].source" "$BUILDAH_CONFIG_FILE_PATH")
    dst=$(yq -r ".copy[$idx].destination" "$BUILDAH_CONFIG_FILE_PATH")

    $BUILDAH_CMD copy "$ctr" "$src" "$dst"
    echo "    - Copying $src â†’ $dst"
    done

    ### Set environment variables
    echo -e "\033[1;33m===>\033[0m ðŸŒ  Setting environment variables"
    yq -r '.env // {} | to_entries[] | "\(.key)=\(.value)"' "$BUILDAH_CONFIG_FILE_PATH" | while IFS='=' read -r key val; do
    echo "  â†’ $key=$val"
    $BUILDAH_CMD config --env "$key=$val" "$ctr"
    done

    ### Extra commands
    echo -e "\033[1;33m===>\033[0m #ï¸âƒ£  Extra commands in container"
    for idx in $(yq -r '.extra_commands | to_entries | .[].key' "$BUILDAH_CONFIG_FILE_PATH"); do
    cmd=$(yq -r ".extra_commands[$idx]" "$BUILDAH_CONFIG_FILE_PATH")

    echo "  â†’ $cmd"
    buildah --storage-driver vfs \
            --root "$BUILDAH_STORAGE_ROOT" \
            --runroot "$BUILDAH_STORAGE_RUNROOT" \
            run "$ctr" -- bash -c "$cmd"
    done

    ### Configure non-root user
    echo -e "\033[1;33m===>\033[0m ðŸ‘¤  Creating non-root user"

    USER_NAME=$(yq -r '.user.name // empty' "$BUILDAH_CONFIG_FILE_PATH")
    USER_SHELL=$(yq -r '.user.shell // "/bin/sh"' "$BUILDAH_CONFIG_FILE_PATH")
    USER_HOME=$(yq -r '.user.home // "/home/'"$USER_NAME"'"' "$BUILDAH_CONFIG_FILE_PATH")
    USER_CHOWN=$(yq -r '.user.chown // empty' "$BUILDAH_CONFIG_FILE_PATH")
    USER_UID=$(yq -r '.user.uid // 1000' "$BUILDAH_CONFIG_FILE_PATH")
    USER_ENABLE_SUDO=$(yq -r '.user.enable_sudo // false' "$BUILDAH_CONFIG_FILE_PATH")

    if [[ -n "$USER_NAME" ]]; then
    echo "  â†’ useradd $USER_NAME"
    $BUILDAH_CMD run "$ctr" -- useradd -m -d "$USER_HOME" -s "$USER_SHELL" "$USER_NAME" -u "${USER_UID}"

        if [[ -n "$USER_CHOWN" ]]; then
            echo "  â†’ chown $USER_NAME:$USER_NAME $USER_CHOWN"
            $BUILDAH_CMD run "$ctr" -- chown -R "$USER_NAME:$USER_NAME" "$USER_CHOWN"
        fi
        if [[ -n "$USER_ENABLE_SUDO" ]]; then
            echo "  â†’ add to sudo"
            $BUILDAH_CMD run "$ctr" -- usermod -aG sudo "$USER_NAME"
        fi
    fi

    USER_NAME=$(yq -r '.set_user // empty | @sh' "$BUILDAH_CONFIG_FILE_PATH")
    if [[ -n "$USER_NAME" ]]; then
    echo "  â†’ Setting final user to: $USER_NAME"
    $BUILDAH_CMD config --user "$USER_NAME" "$ctr"
    fi

    ### Set entrypoint
    echo -e "\033[1;33m===>\033[0m ðŸšª  Setting entrypoint"
    ENTRYPOINT=$(yq -r '.entrypoint // empty | @sh' "$BUILDAH_CONFIG_FILE_PATH")
    if [[ -n "$ENTRYPOINT" ]]; then
    echo "  â†’ ENTRYPOINT: $ENTRYPOINT"
    eval "set -- $ENTRYPOINT"
    $BUILDAH_CMD config --entrypoint "$ENTRYPOINT" "$ctr"
    fi

    ### Set cmd
    echo -e "\033[1;33m===>\033[0m ðŸšª  Setting cmd"
    IMAGE_CMD=$(yq -r '.cmd // empty | @sh' "$BUILDAH_CONFIG_FILE_PATH")
    if [[ -n "$IMAGE_CMD" ]]; then
    echo "  â†’ ENTRYPOINT: $IMAGE_CMD"
    eval "set -- $IMAGE_CMD"
    $BUILDAH_CMD config --cmd "$IMAGE_CMD" "$ctr"
    fi


    ### Save image
    echo -e "\033[1;33m===>\033[0m ðŸ“¦  Committing image"

    $BUILDAH_CMD commit "$ctr" "$FULL_IMAGE_NAME"
    echo "  â†’ Image committed as $FULL_IMAGE_NAME"

    ### Save image to tarball
    echo -e "\033[1;33m===>\033[0m ðŸ—„ï¸  Exporting image to file"
    IMAGE_TAR="container-image.tar"
    $BUILDAH_CMD push "$FULL_IMAGE_NAME" "docker-archive:$IMAGE_TAR"
    echo "  â†’ Image saved as $IMAGE_TAR"

    ### Cleanup
    echo -e "\033[1;33m===>\033[0m ðŸ§¼  Cleaning up"
    $BUILDAH_CMD rm "$ctr"
