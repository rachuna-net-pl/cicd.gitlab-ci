---
variables:
  DOCS_MD_FILE_PATH: ci_pipelines/opentofu-module/README.md

ðŸ•µ opentofu fmt:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  script:
    - tofu fmt -recursive -check
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

âœ… tflint:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  script:
    - tflint
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

âœ… terraform-docs:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  script:
    - |
      cp README.md README.md.bak
      if [ -f .terraform-docs.yml ]; then
        terraform-docs -c .terraform-docs.yml .
      else
        terraform-docs md . > README.md
      fi
      diff README.md README.md.bak
      EXIT_CODE=$?

      if [[ $EXIT_CODE -eq 1 ]]; then
        git add README.md
        git commit -m "docs: update README.md"
        git push origin HEAD:$CI_COMMIT_REF_NAME

      elif [[ $EXIT_CODE -eq 0 ]]; then
        echo "Brak zmian"

      else
        echo "BÅ‚Ä…d diff (exit code: $EXIT_CODE)"
        exit $EXIT_CODE
      fi
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success
