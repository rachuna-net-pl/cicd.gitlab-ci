---
variables:
  DOCS_MD_FILE_PATH: ci_pipelines/opentofu/README.md

include:
  - local: "ci_pipelines/opentofu/tofu-init.sh.yml"

üïµ opentofu fmt:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
  script:
    - tofu fmt -recursive -check
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

‚úÖ opentofu validate:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - !reference [.tofu-init.sh.yml]
  script:
    - tofu validate
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

‚úÖ tflint:
  image: $IMAGE_OPENTOFU
  stage: validate
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - !reference [.tofu-init.sh.yml]
  script:
    - tflint
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

üß™ opentofu plan:
  image: $IMAGE_OPENTOFU
  stage: unit-test
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - !reference [.tofu-init.sh.yml]
  script:
    - tofu plan
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - when: on_success

üí• opentofu apply:
  image: $IMAGE_OPENTOFU
  stage: deploy
  needs:
    - job: üìç Publish Version
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - !reference [.tofu-init.sh.yml]
  script:
    - tofu apply -auto-approve
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
    - if: $CI_OPEN_MERGE_REQUESTS
      when: manual
