---
include:
  - local: "jobs/code_review/.codex/manifests/001-manifest.sh.yml"
  - local: "jobs/code_review/.codex/profiles/001-reviewer.sh.yml"
  - local: "jobs/code_review/.codex/prompts/001-code-review.sh.yml"

üïµ AI Code Review:
  stage: release
  image: registry.rachuna-net.pl/pl.rachuna-net/containers/codex:1.0.0
  variables:
    CODEX_MODEL: "gpt-5-codex"
    AI_REVIEW_MAX_DIFF_CHARS: "120000"
    AI_REVIEW_MAX_NOTE_CHARS: "20000"
  before_script:
    - !reference [.helper_gitlab-ci.sh]
    - |
      echo ""
      echo -e "\033[1;33m===>\033[0m ‚öôÔ∏è  Configure Code Reviewer"
      mkdir -p $HOME/.codex .codex/prompts .codex/docs
      VAULT_SECRETS=$(curl -sS -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/kv-gitlab/data/pl.rachuna-net/auth/codex")
      echo $VAULT_SECRETS | jq -r '.data.data.AUTH_CONFIG' > $HOME/.codex/auth.json
      export GITLAB_TOKEN=$(echo $VAULT_SECRETS | jq -r '.data.data.GITLAB_TOKEN')
    - !reference [.001-manifest.sh]
    - !reference [.001-reviewer.sh]
    - !reference [.001-code-review.sh]
  script:
    - |
      echo ""
      MR_JSON=$(curl -sS -H "PRIVATE-TOKEN: $GITLAB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID")
      REVIEWER_LOGINS=$(echo "$MR_JSON" | jq -r '.reviewers[].username')

      if ! echo "$REVIEWER_LOGINS" | grep -Eq "aideveloper"; then
        echo "‚õî Ten MR nie ma wymaganego reviewera ‚Äì pomijam AI Code Review."
        exit 0
      fi

      echo -e "\033[1;33m===>\033[0m üöÄ Code Review"

      if [ -z "$CI_MERGE_REQUEST_IID" ]; then
        echo "Brak CI_MERGE_REQUEST_IID ‚Äì nie jeste≈õmy w pipeline MR. Ko≈Ñczƒô."
        exit 0
      fi

      echo -e "\033[1;34m--> Pobieram diff z MR #$CI_MERGE_REQUEST_IID\033[0m"
      CHANGES_JSON=$(curl -sS -H "PRIVATE-TOKEN: $GITLAB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/changes")
      echo "$CHANGES_JSON" | jq -e '.changes' >/dev/null 2>&1 || {
        echo "Nie uda≈Ço siƒô sparsowaƒá odpowiedzi z GitLaba (brak .changes)."
        echo "$CHANGES_JSON"
        exit 1
      }

      DIFF_MD_PATH="$CI_PROJECT_DIR/.codex/docs/diff.md"
      : > "$DIFF_MD_PATH"

      echo "$CHANGES_JSON" | jq -r '
        .changes[] |
        select(.diff != null and (.diff | length > 0)) |
        "### \(.new_path // .old_path)\n```diff\n\(.diff)\n```\n"
      ' >> "$DIFF_MD_PATH"

      if [ ! -s "$DIFF_MD_PATH" ]; then
        echo "Brak zmian w MR ‚Äì wrzucam kr√≥tki komentarz."
        REVIEW_TEXT="Brak zmian do przejrzenia (pusty diff)."
      else
        MAX_DIFF=${AI_REVIEW_MAX_DIFF_CHARS:-120000}
        if [ "$(wc -c < "$DIFF_MD_PATH")" -gt "$MAX_DIFF" ]; then
          echo -e "\n> (Diff uciƒôty przez limit ${MAX_DIFF} znak√≥w ‚Äì pe≈Çny diff jest w MR)\n" >> "$DIFF_MD_PATH"
          TMP_TRUNC="$CI_PROJECT_DIR/.codex/docs/diff-trunc.md"
          head -c "$MAX_DIFF" "$DIFF_MD_PATH" > "$TMP_TRUNC" && mv "$TMP_TRUNC" "$DIFF_MD_PATH"
        fi

        REVIEW_INPUT="$CI_PROJECT_DIR/.codex/docs/code-review-input.md"
        : > "$REVIEW_INPUT"

        {
          echo "# Manifest"
          cat "$CI_PROJECT_DIR/.codex/manifests/"*
          echo ""

          echo "# Reviewer profile"
          cat "$CI_PROJECT_DIR/.codex/profiles/"*
          echo ""

          echo "# Code review task"
          cat "$CI_PROJECT_DIR/.codex/prompts/"*
          echo ""

          echo "# Git diff to review"
          cat "$DIFF_MD_PATH"
        } >> "$REVIEW_INPUT"

        REVIEW_OUTPUT="$CI_PROJECT_DIR/.codex/docs/code-review-output.md"
        : > "$REVIEW_OUTPUT"

        echo -e "\033[1;34m--> Uruchamiam codex exec (model: ${CODEX_MODEL})\033[0m"

        CODEX_LOG="$CI_PROJECT_DIR/.codex/docs/codex-exec.log"
        codex exec \
          --model "${CODEX_MODEL}" \
          --sandbox read-only \
          --cd "$CI_PROJECT_DIR" \
          --output-last-message "$REVIEW_OUTPUT" \
          - < "$REVIEW_INPUT" 2> "$CODEX_LOG"

        if [ ! -s "$REVIEW_OUTPUT" ]; then
          echo "Codex nie zwr√≥ci≈Ç ≈ºadnej tre≈õci ‚Äì wstawiam fallback."
          REVIEW_TEXT="Nie uda≈Ço siƒô uzyskaƒá odpowiedzi od AI Developer. Sprawd≈∫ logi joba."
        else
          REVIEW_TEXT="$(cat "$REVIEW_OUTPUT")"
          SHA="${CI_COMMIT_SHA:-unknown}"

          BODY="${REVIEW_TEXT}"

          MAX_NOTE=${AI_REVIEW_MAX_NOTE_CHARS:-20000}
          BODY_TRUNC=$(printf "%b" "$BODY" | head -c "$MAX_NOTE")

          if [ "${#BODY}" -gt "$MAX_NOTE" ]; then
            BODY_TRUNC="${BODY_TRUNC}

          > (Komentarz uciƒôty przez limit ${MAX_NOTE} znak√≥w ‚Äì pe≈Çne review dostƒôpne w artefakcie joba.)"
          fi

          NOTE_URL="$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"

          echo -e "\033[1;34m--> Publikujƒô komentarz AI Developer do MR\033[0m"

          HTTP_CODE=$(curl -sS -o /tmp/ai_note_response.json -w "%{http_code}" \
            -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --data-urlencode "body=${BODY_TRUNC}" \
            "$NOTE_URL")

          echo "HTTP_CODE: ${HTTP_CODE}"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "‚ùå B≈ÇƒÖd podczas publikacji komentarza:"
            cat /tmp/ai_note_response.json || true
            exit 1
          else
            echo "‚úÖ Komentarz AI Developer zosta≈Ç dodany do MR"
          fi
        fi
      fi

  artifacts:
    when: always
    paths:
      - .codex/docs/
    expire_in: "1 day"
  after_script:
    - !reference [.helper_readme.sh]
  rules:
    - if: $CI_SERVER_HOST == "gitlab.com"
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never
